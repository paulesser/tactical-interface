<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>âœ‚</title>
        <script src="https://cdn.jsdelivr.net/npm/p5@1.11.11/lib/p5.js"></script>
        <style>
            * {
                padding: 0;
                margin: 0;
                box-sizing: border-box;
            }
        </style>
    </head>
    <body>
        <main></main>
        <script>
            let capture;
            let result = "";
            let lastMilliSeconds = 0;
            let countdown = 0;
            function setup() {
                createCanvas(640, 480);
                capture = createCapture(VIDEO);
                capture.size(width, height);
                capture.hide();
                frameRate(14);
            }
            function draw() {
                // background(0);
                countdown = round((millis() - lastMilliSeconds) / 1000);
                if (countdown >= 10) {
                    ocr();
                    lastMilliSeconds = millis();
                }
                image(capture, 0, 0);
                textSize(40);
                fill(0);
                text(10 - (countdown + 1), 10, 60);
                fill(0, 240, 0);
                textSize(20);
                text(result, 10, height - 60);
                if (result.length > 0) {
                    typeKeyboard(result);
                    result = "";
                }
            }

            async function ocr() {
                const canvas = document.querySelector("canvas");
                if (!canvas) {
                    return;
                }
                canvas.toBlob(
                    async (blob) => {
                        const form = new FormData();
                        form.append("image", blob);
                        const response = await fetch(
                            "https://tactics.typetable.xyz/ocr",
                            {
                                method: "POST",
                                body: form,
                            },
                        );
                        if (response.ok) {
                            let text = await response.text();
                            if (text.length > 0) {
                                let mapped = text
                                    .split('"')
                                    .join(" ")
                                    .split(",")
                                    .join(" ")
                                    .split(";")
                                    .join(" ");
                                result = mapped;
                            } else {
                                result = "";
                            }
                        }
                    },
                    "image/jpeg",
                    0.95,
                );
            }

            async function typeKeyboard(text) {
                const response = await fetch(`http://127.0.0.1:3080/keyboard`, {
                    method: "POST",
                    body: text,
                });
                if (response.ok) {
                    const text = await response.text();
                    console.log(text);
                }
            }
        </script>
    </body>
</html>
